#!/usr/bin/env bash

set -euo pipefail

source $ROOT/vm/common.sh

# TODO: I need to prepare the test_runner so I don't have to do "uv run" I can just "pytest", I want dependencies installed ahead of time. This will be different for dev runner.

require_cmd qemu-img qemu-system-aarch64 ssh ssh-keygen rsync nc

usage="Usage: tests [--interactive]

Run the test suite.

Options:
    -i,--interactive      Re-run the test suite on changes, attaches TTY to VM
"

INTERACTIVE_FLAG=""

# check command flags
for arg in "$@"; do
    case "$arg" in
        -h|--help)
            echo "$usage"
            exit
            ;;
        -i|--interactive)
            INTERACTIVE_FLAG="0"
            ;;
        *)
            >&2 echo "Error: Unknown argument"
            echo "$usage"
            exit 1
    esac
done

# tests run in overlay img so startup environment is controlled and runtime
# effects are isolated 
BASE_IMG="$ROOT/vm/test_runner.img"
TEST_IMG="$ROOT/vm/test_run_1.img"
qemu-img create -f qcow2 -B qcow2 -b "$BASE_IMG" "$TEST_IMG" &>/dev/null
trap "rm -f $TEST_IMG" EXIT

ssh="ssh \
    -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    -o ConnectTimeout=1 \
    -o ConnectionAttempts=1 \
    -o LogLevel=quiet \
    -p 2222 \
    -i $ROOT/vm/ssh-key"

# limit to half of cores on host
cores="$(($(sysctl -n hw.ncpu) / 2))"
# limit to fourth of memory on host
mem="$(($(sysctl -n hw.memsize) / (1024 * 1024 * 4)))"

echo "Booting vm"
vm_pidfile=$(mktemp)
qemu-system-aarch64 \
    -bios "$(brew --prefix qemu)/share/qemu/edk2-aarch64-code.fd" \
    -accel hvf \
    -cpu host \
    -machine virt,highmem=on \
    -smp "$cores" \
    -m "$mem" \
    -serial mon:stdio \
    -display none \
    -drive "if=virtio,format=qcow2,file=$TEST_IMG" \
    -nic user,model=virtio-net-pci,hostfwd=tcp::2222-:22 \
    &>/dev/null \
    &
qemu_pid=$!

# TODO: on failure, remove the test run vm too. We'll make better debugging
# utilities later
trap "kill $qemu_pid" ERR

printf "  - checking for port readiness..."
until nc -z localhost 2222 &>/dev/null; do
    sleep 0.1
    printf "."
done
printf "Done\n"

printf "  - checking for ssh availability..."
until $ssh faas_user@localhost true &>/dev/null
do
    printf "."
done
printf "Done\n"

if [ -z $INTERACTIVE_FLAG ]; then
    printf "  - copying test files onto vm..."
    rsync \
        -e "$ssh" \
        -qa \
        --include "pyproject.toml" \
        --include "pytest.toml" \
        --include "uv.lock" \
        --include "src/***" \
        --include "tests/***" \
        --exclude "*" \
        "$ROOT/" faas_user@localhost:~
    printf "Done\n"

    echo "Executing test suite"
    $ssh faas_user@localhost 'ls -al && uv run pytest && sudo shutdown -h now'
else
    printf "  - copying test files onto vm..."
    rsync \
        -e "$ssh" \
        -qa \
        --include "pyproject.toml" \
        --include "pytest.toml" \
        --include "uv.lock" \
        --include "src/***" \
        --include "tests/***" \
        --exclude "*" \
        "$ROOT/" faas_user@localhost:~
    printf "Done\n"

    echo "Starting interactive session..."
    $ssh -t faas_user@localhost 'bash -l '
    echo "Session ended, shutting down vm..."
    $ssh faas_user@localhost 'sudo shutdown -h now'
fi

wait
